#!/usr/bin/env python3
"""
load info table of samples
load files from each patient: samples in rows, genes in columns
get size of each sample and plot it
(i.e. abundance of genes with in each sample)

concat all samples in one table and keep union of all genes,
then fill NaNs with zero

CLEAN THE data FROM ALL SAMPLES
extract the start, end and chrom info from the table
and keep only the functions values
remove genes that exist in multiple chromosomes across samples

ORDER THE GENES FROM ALL SAMPLES
if the gene names are duplicated, through an exception

CREATE dictionary of gene names and their order
ORDER the table by gene position

PLOT Abundance of gene data per sample:
'oncoscan_events', 'oncoscan_events_filt',
'genes_with_CNV', 'genes_with_CNV_merged'

SAVE table w/ and w/o positions:
'table_withPos.csv'
'table.csv'

PLOT heatmap before gene ordering

CHECK if there are empty genes and remove them
PLOT  heatmap after gene ordering and cleaning

SAVE ordered table and gene pos info table:
'table_ordered.csv'
'genes_info.csv'

$ set_up_endometrial withFilter=False reportName=set_up_endometrial >> ./data/output/set_up_endometrial.log
$ set_up_endometrial withFilter=True reportName=set_up_endometrial_FILT >> ./data/output/set_up_endometrial_FILT.log
"""

from gene_signatures.set_up_oncoscan import (
    set_up_oncoscan
)
from gene_signatures.core import (
    custom_div_cmap
)
from omics_processing.io import (
    set_directory
    )
import os
import sys
import plac
import logging
import matplotlib
import matplotlib.pyplot as plt

script_path = os.path.dirname(__file__)
script_fname = os.path.basename(__file__).rsplit('.')[0]

filt_kwargs = {
    'col_pValue': 'Call PValue',
    'col_probeMedian': 'Probe Median',
    'col_probeCount': 'Probes',
    'pValue_thres': 0.01,
    'probeMedian_thres': 0.3,
    'probeCount_thres': 20,
    'remove_missing_pValues': False
}

preproc_kwargs = {
    # columns with info about:
    # Chromosome Region, Event, Gene Symbols
    # (in this order!!!)
    'keep_columns': ['Chromosome Region', 'Event', 'Gene Symbols'],
}

function_dict = {
    'Homozygous Copy Loss': -4,
    'CN Loss': -2,
    'CN Gain': 2,
    'High Copy Gain': 4,
    'LOH': -1
}

plot_kwargs = {
    'cmap_custom': custom_div_cmap(9),
    'vmin': -4,
    'vmax': 4
}

set_up_kwargs_default = {
    # script set up params
    'saveReport': True,
    'txt_label': 'set up Oncoscan data',
    'toPrint': True,
    'reportName': 'debug_set_up_endometrial',#script_fname,
    'editWith': 'Oncoscan',
    'withFilter': False,
    'withPreprocess': True,
    'filt_kwargs': filt_kwargs,
    'chr_col': 'chr_int',
    'gene_id_col': 'gene',
    'remove_patients': None,
    'sample_info_fname': '20180704_emca.csv',
    'sample_info_table_index_colname': 'Oncoscan_ID',
    'sample_info_table_sortLabels': 'TP53_mut5,FOXA1_mut5',
    'plot_kwargs': plot_kwargs,

    # params only for internal usage in function
    # load_and_process_summary_file() in core.py
    'samples_colname': 'Sample',
    'preproc_kwargs': preproc_kwargs,
    'comment': "#",
    'removeLOH': True,
    'function_dict': function_dict,
    'mergeHow': 'maxAll',

    # set directories
    'input_directory': 'input',
    'oncoscan_directory': 'fromNexusExpress',
    'oncoscan_files': 'DS_097_all_samples.txt,18044_all_samples.txt',
    'output_directory': 'output',
    'DEBUG': True
}


@plac.annotations(
    set_up_kwargs='keyword arguments'
)
def main(**set_up_kwargs):

    # update the default key/value pairs if the user gives different values
    # and take the union of all pairs
    set_up_kwargs_default.update(set_up_kwargs)

    if set_up_kwargs_default.get('DEBUG'):
        logging.basicConfig(stream=sys.stdout, level=logging.DEBUG)

    set_up_oncoscan(**set_up_kwargs_default)


if __name__ == '__main__':
    plac.call(main)
